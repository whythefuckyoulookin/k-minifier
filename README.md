---
author: @whythefuckyoulookin
date: 29/10/2025
---

# kMinifier

> NestJS сервер для минификации CSS файлов с поддержкой бэкапов

## Установка

```bash
# Установка зависимостей
npm install

# Создание файла конфигурации (если нет .env.example, смотрите раздел "Переменные окружения")
cp .env.example .env
```

**Примечание:** Если файл `.env.example` отсутствует, создайте его вручную по примеру из раздела "Переменные окружения" ниже.

## Доступные команды

```bash
# Разработка
npm run start:dev          # Запуск в режиме разработки с hot-reload

# Сборка
npm run build              # Компиляция TypeScript в JavaScript (результат в папке dist/)

# Запуск
npm start                  # Базовый запуск приложения
npm run start:prod         # Запуск собранного приложения (требуется npm run build)

# Отладка
npm run start:debug        # Запуск с отладчиком и hot-reload

# Линтинг и форматирование
npm run lint               # Проверка и автоматическое исправление кода с ESLint
npm run format             # Форматирование кода с помощью Prettier
```

### Развертывание в продакшн

```bash
# 1. Установка зависимостей
npm install

# 2. Сборка проекта
npm run build

# 3. Запуск
npm run start:prod
```

## Структура проекта

### Главные файлы

#### `main.ts`
Точка входа приложения. Создает NestJS приложение, настраивает:
- Helmet middleware для безопасности
- Глобальный префикс `/api` для всех маршрутов
- Swagger документацию
- Graceful shutdown для сигналов SIGTERM и SIGINT

#### `app.module.ts`
Корневой модуль приложения, объединяющий все функциональные модули. Регистрирует:
- Глобальные модули (ConfigModule, LoggerModule)
- CSS модуль
- Глобальный интерцептор логирования (LoggerInterceptor)
- Глобальный фильтр исключений (AllHttpExceptionsFilter)
- Middleware для генерации Request ID

---

### Конфигурация (`config/`)

#### `app.config.ts`
Конфигурация основных параметров приложения:
- Порт сервера (по умолчанию 3000)
- Настройки Swagger (путь, опции документации)

#### `css.config.ts`
Конфигурация параметров минификации CSS:
- Путь для сохранения минифицированных файлов (`__minified__`)
- Опции LightningCSS (минификация, source maps)

#### `files.config.ts`
Конфигурация работы с файлами:
- Путь для загрузки файлов (`uploads`)
- Алгоритм хеширования (SHA256)

#### `logger.config.ts`
Конфигурация логирования с использованием Winston. Содержит:
- Формат логов (JSON)
- Конфигурацию транспортов (DailyRotateFile)
- Настройки ротации и хранения файлов
- Параметры обработки исключений и отклонений промисов

---

### CSS модуль (`css/`)

#### `css.controller.ts`
HTTP контроллер с эндпоинтами для минификации CSS и работы с бэкапами:
- `POST /api/css/minify` - минификация CSS файла
- `GET /api/css/backup/list` - список бэкапов клиента
- `GET /api/css/backup?t=timestamp` - получение конкретного бэкапа

#### `css.service.ts`
Сервис для минификации CSS файлов и управления бэкапами. Функциональность:
- Минификация CSS с использованием LightningCSS
- Кеширование минифицированных файлов по хешу (SHA256)
- Автоматическое создание бэкапов с timestamp и UUID
- Структура хранения бэкапов: `platform/login/timestamp-uuid.filename`

#### `css.module.ts`
Модуль CSS, регистрирует контроллер и сервис, импортирует FilesModule.

#### Декораторы (`decorators/`)

**`client-headers.decorator.ts`**
Декоратор для извлечения и валидации заголовков клиента (`x-client-platform`, `x-client-login`) из HTTP запроса.

**`css-swagger.decorator.ts`**
Декораторы Swagger для документирования API эндпоинтов CSS модуля.

#### DTO (`dto/`)

**`css-file.dto.ts`**
DTO для описания загружаемого CSS файла в Swagger документации.

#### Pipes (`pipes/`)

**`parse-css-file.pipe.ts`**
Pipe для валидации загружаемых CSS файлов. Проверяет:
- Тип файла (text/css)
- Максимальный размер (10 МБ)

---

### Файловый модуль (`files/`)

#### `files.service.ts`
Сервис для работы с файловой системой. Предоставляет методы для:
- Сохранения файлов с автоматическим созданием директорий
- Чтения файлов с обработкой ошибок
- Чтения содержимого директорий
- Хеширования файлов (SHA256)
- Автоматической инициализации окружения при запуске

#### `files.module.ts`
Модуль файлов, экспортирует FilesService для использования в других модулях.

---

### Логирование (`logger/`)

#### `logger.service.ts`
Сервис логирования с использованием Winston. Особенности:
- Инициализация Winston logger с конфигурацией из `logger.config.ts`
- Методы логирования: error, warn, debug, verbose, log
- Область действия: TRANSIENT (новый экземпляр для каждого использования)
- Поддержка контекста для идентификации источника логов
- Автоматическое добавление timestamp к каждому логу

#### `logger.module.ts`
Глобальный модуль логгера, экспортирует LoggerService.

#### Интерцепторы (`interceptors/`)

**`logger.interceptor.ts`**
Глобальный интерцептор для автоматического логирования всех успешных HTTP запросов. Логирует:
- Информацию о клиенте (platform, login, IP)
- Данные запроса (метод, endpoint, content-type, content-length, query)
- Статус ответа
- Request ID

#### Фильтры (`filters/`)

**`logger.filter.ts`**
Глобальный фильтр для перехвата и обработки всех HTTP исключений. Функциональность:
- Детальное логирование ошибок с полной информацией о запросе
- Логирование стека ошибки с удалением абсолютных путей
- Возврат стандартизированного ответа об ошибке (statusCode, timestamp, path)
- Интеграция с LoggerService

---

### Middleware (`middlewares/`)

#### `request-id.middleware.ts`
Middleware для генерации уникального идентификатора для каждого запроса:
- Генерирует UUID v4 для каждого запроса
- Добавляет Request ID в объект запроса
- Устанавливает заголовок `X-Request-Id` в ответе
- Применяется ко всем маршрутам приложения

---

### Утилиты (`utils/`)

#### `setup-swagger.ts`
Утилита для настройки и инициализации Swagger документации с поддержкой YAML формата.

---

### Константы (`consts/`)

#### `file.ts`
Константы для работы с файлами:
- `MAX_CSS_FILE_SIZE` - максимальный размер загружаемого CSS файла (10 МБ)

---

## API Endpoints

### Минификация CSS

```http
POST /api/css/minify
Content-Type: multipart/form-data
Headers:
  x-client-platform: название_платформы
  x-client-login: логин_пользователя

Body:
  file: css-файл
```

### Список бэкапов

```http
GET /api/css/backup/list
Headers:
  x-client-platform: название_платформы
  x-client-login: логин_пользователя
```

### Получение бэкапа

```http
GET /api/css/backup?t=timestamp
Headers:
  x-client-platform: название_платформы
  x-client-login: логин_пользователя
```

---

## Swagger документация

Доступна по адресу: `http://localhost:3000/swagger`

---

## Особенности

- Минификация CSS с помощью LightningCSS
- Автоматическое создание бэкапов загруженных файлов с timestamp и UUID
- Кеширование минифицированных файлов по хешу SHA256
- Валидация входящих файлов (тип, размер)
- Структурированное логирование всех запросов и ошибок
- Ротация логов по дням (хранение 30 дней)
- Раздельное хранение логов приложения и ошибок
- Уникальный Request ID для каждого запроса (заголовок `X-Request-Id`)
- Graceful shutdown для SIGTERM и SIGINT
- Helmet security middleware
- Swagger API документация (JSON и YAML форматы)
- Глобальный префикс `/api` для всех маршрутов
- Идентификация клиентов через заголовки `x-client-platform` и `x-client-login`

---

## Переменные окружения

Создайте файл `.env` в корне проекта на основе `.env.example`:

### .env.example

```env
# Порт сервера (по умолчанию 3000)
PORT=3000
```

### Описание переменных

- `PORT` - порт, на котором будет запущен сервер (по умолчанию: 3000)

---

## Структура хранения файлов

```
uploads/
├── __minified__/              # Минифицированные CSS файлы (кеш по хешу)
│   └── {sha256}.min.css
└── {platform}/                # Бэкапы по платформам
    └── {login}/               # Бэкапы по пользователям
        └── {timestamp}-{uuid}.{filename}
```

---

## Логирование

Приложение использует Winston для структурированного логирования. Вся конфигурация транспортов вынесена в `logger.config.ts`.

### Файлы логов

- `logs/app-YYYY-MM-DD.log` - все логи уровня info и выше (кроме error)
- `logs/err-YYYY-MM-DD.log` - только логи уровня error

### Формат логов

Все логи содержат:
- `timestamp` - время события в ISO формате
- `contextName` - имя контекста (модуль/сервис)
- `ctx` - информация о клиенте (platform, login, IP)
- `req` - данные запроса (method, endpoint, content-type, query)
- `resStatus` - статус ответа
- `reqId` - уникальный идентификатор запроса
- `err` - информация об ошибке (только для error логов)

### Хранение

Логи автоматически ротируются ежедневно и хранятся 30 дней.

---

## Заголовки клиента

Все эндпоинты требуют следующие заголовки для идентификации клиента:

- `x-client-platform` - название платформы клиента (обязательный)
- `x-client-login` - логин пользователя (обязательный)

Эти заголовки используются для:
- Организации структуры хранения бэкапов
- Логирования и аудита действий
- Управления доступом к бэкапам

---

## Обработка ошибок

Приложение использует глобальный фильтр исключений (`AllHttpExceptionsFilter`):
- Перехватывает все HTTP исключения
- Логирует детальную информацию об ошибке
- Возвращает стандартизированный JSON ответ:
  ```json
  {
    "statusCode": 404,
    "timestamp": "2025-10-29T12:00:00.000Z",
    "path": "/api/css/backup"
  }
  ```
